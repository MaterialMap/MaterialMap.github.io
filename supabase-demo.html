<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material MAP - Supabase Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .material-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            transition: box-shadow 0.3s;
        }
        .material-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .lsdyna-code {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üß™ Material MAP - Supabase Demo</h1>
                <p class="text-center text-muted">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Supabase</p>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
        <div class="row mb-4">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="supabaseUrl" class="form-label">Supabase URL</label>
                            <input type="url" class="form-control" id="supabaseUrl" 
                                   placeholder="https://your-project-ref.supabase.co">
                        </div>
                        <div class="mb-3">
                            <label for="supabaseKey" class="form-label">Anon Key</label>
                            <input type="password" class="form-control" id="supabaseKey" 
                                   placeholder="–í—Å—Ç–∞–≤—å—Ç–µ anon key –∏–∑ Supabase Dashboard">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="connectToSupabase()">
                            –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="loadDemo()">
                            –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row" id="statsSection" style="display: none;">
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="materialsCount">-</h3>
                    <p>–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="referencesCount">-</h3>
                    <p>–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="applicationsCount">-</h3>
                    <p>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="row" id="searchSection" style="display: none;">
            <div class="col-12 mb-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="–ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: aluminum, steel, MAT_ELASTIC)">
                    <button class="btn btn-primary" onclick="searchMaterials()">üîç –ü–æ–∏—Å–∫</button>
                    <button class="btn btn-outline-secondary" onclick="loadAllMaterials()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                </div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="row">
            <div class="col-12">
                <div id="results">
                    <div class="loading" id="loadingIndicator" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
    <div class="modal fade" id="materialModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="materialModalTitle">–ú–∞—Ç–µ—Ä–∏–∞–ª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="materialModalBody">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="button" class="btn btn-primary" id="copyMaterialBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å LS-DYNA</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        let supabase = null;
        let currentMaterial = null;

        window.connectToSupabase = async function() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ –∫–ª—é—á');
                return;
            }

            try {
                supabase = createClient(url, key);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                const { data, error } = await supabase
                    .from('materials')
                    .select('count', { count: 'exact', head: true });

                if (error) throw error;

                document.getElementById('statsSection').style.display = 'flex';
                document.getElementById('searchSection').style.display = 'block';
                
                await loadStats();
                await loadAllMaterials();
                
                alert('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        };

        window.loadDemo = function() {
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('supabaseUrl').value = 'https://rjacdeibxldgustnaaqm.supabase.co';
            document.getElementById('supabaseKey').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqYWNkZWlieGxkZ3VzdG5hYXFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NDA2NTUsImV4cCI6MjA3MTUxNjY1NX0.emCdShgCsY9UdTepEPu7d9tj0ZkkIJ6FX4lxebDJIVE';
            alert('‚úÖ –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"');
        };

        window.loadStats = async function() {
            if (!supabase) return;

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const [materials, references, applications] = await Promise.all([
                    supabase.from('materials').select('count', { count: 'exact', head: true }),
                    supabase.from('references').select('count', { count: 'exact', head: true }),
                    supabase.from('applications').select('count', { count: 'exact', head: true })
                ]);

                document.getElementById('materialsCount').textContent = materials.count || 0;
                document.getElementById('referencesCount').textContent = references.count || 0;
                document.getElementById('applicationsCount').textContent = applications.count || 0;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        };

        window.loadAllMaterials = async function() {
            if (!supabase) return;

            showLoading(true);
            try {
                const { data: materials, error } = await supabase
                    .from('materials_full')
                    .select('*')
                    .order('name')
                    .limit(20);

                if (error) throw error;

                displayMaterials(materials || []);
            } catch (error) {
                displayError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message);
            } finally {
                showLoading(false);
            }
        };

        window.searchMaterials = async function() {
            if (!supabase) return;

            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                loadAllMaterials();
                return;
            }

            showLoading(true);
            try {
                const { data: materials, error } = await supabase
                    .from('materials_full')
                    .select('*')
                    .or(`name.ilike.%${query}%,description.ilike.%${query}%,material_type_code.ilike.%${query}%`)
                    .order('name')
                    .limit(20);

                if (error) throw error;

                displayMaterials(materials || []);
                
                if (materials.length === 0) {
                    displayError('–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.');
                }
            } catch (error) {
                displayError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
            } finally {
                showLoading(false);
            }
        };

        function displayMaterials(materials) {
            const resultsDiv = document.getElementById('results');
            
            if (materials.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted text-center">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            const materialsHtml = materials.map(material => `
                <div class="material-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${material.name}</h5>
                            <p class="text-muted">${material.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                            <div class="mb-2">
                                <span class="badge bg-primary">${material.material_type_code || 'N/A'}</span>
                                <span class="badge bg-secondary">œÅ=${material.density || 'N/A'}</span>
                                <span class="badge bg-secondary">E=${material.youngs_modulus || 'N/A'}</span>
                                <span class="badge bg-info">${material.units}</span>
                            </div>
                            <div class="mb-2">
                                <strong>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</strong> 
                                ${material.applications?.join(', ') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="viewMaterial('${material.id}')">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="copyMaterial('${material.id}')">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = materialsHtml;
        }

        window.viewMaterial = async function(materialId) {
            if (!supabase) return;

            try {
                const { data: material, error } = await supabase
                    .from('materials_full')
                    .select('*')
                    .eq('id', materialId)
                    .single();

                if (error) throw error;

                currentMaterial = material;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('materialModalTitle').textContent = material.name;
                document.getElementById('materialModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h6>
                            <table class="table table-sm">
                                <tr><td>–¢–∏–ø:</td><td>${material.material_type_code || 'N/A'}</td></tr>
                                <tr><td>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å:</td><td>${material.density || 'N/A'}</td></tr>
                                <tr><td>–ú–æ–¥—É–ª—å –Æ–Ω–≥–∞:</td><td>${material.youngs_modulus || 'N/A'}</td></tr>
                                <tr><td>–ö–æ—ç—Ñ—Ñ. –ü—É–∞—Å—Å–æ–Ω–∞:</td><td>${material.poisson_ratio || 'N/A'}</td></tr>
                                <tr><td>–ü—Ä–µ–¥–µ–ª —Ç–µ–∫—É—á–µ—Å—Ç–∏:</td><td>${material.yield_strength || 'N/A'}</td></tr>
                                <tr><td>–ï–¥–∏–Ω–∏—Ü—ã:</td><td>${material.units}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è</h6>
                            <ul>
                                ${material.applications?.map(app => `<li>${app}</li>`).join('') || '<li>–ù–µ —É–∫–∞–∑–∞–Ω–æ</li>'}
                            </ul>
                            <h6>–ò—Å—Ç–æ—á–Ω–∏–∫–∏</h6>
                            <ul>
                                ${material.reference_urls?.map(url => `<li><a href="${url}" target="_blank">${url}</a></li>`).join('') || '<li>–ù–µ —É–∫–∞–∑–∞–Ω–æ</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    ${material.description ? `<div class="mt-3"><h6>–û–ø–∏—Å–∞–Ω–∏–µ</h6><p>${material.description}</p></div>` : ''}
                    ${material.comments ? `<div class="mt-3"><h6>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h6><p>${material.comments}</p></div>` : ''}
                    
                    <div class="mt-3">
                        <h6>LS-DYNA –¥–∞–Ω–Ω—ã–µ</h6>
                        <div class="lsdyna-code">${material.mat_data_raw}</div>
                        ${material.eos_data_raw ? `<h6 class="mt-3">EOS –¥–∞–Ω–Ω—ã–µ</h6><div class="lsdyna-code">${material.eos_data_raw}</div>` : ''}
                    </div>
                `;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = new bootstrap.Modal(document.getElementById('materialModal'));
                modal.show();

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + error.message);
            }
        };

        window.copyMaterial = async function(materialId) {
            if (!supabase) return;

            try {
                const { data: material, error } = await supabase
                    .from('materials_full')
                    .select('mat_data_raw, eos_data_raw')
                    .eq('id', materialId)
                    .single();

                if (error) throw error;

                let textToCopy = material.mat_data_raw || '';
                if (material.eos_data_raw) {
                    textToCopy += '\n\n' + material.eos_data_raw;
                }

                await navigator.clipboard.writeText(textToCopy);
                alert('‚úÖ LS-DYNA –¥–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');

            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        };

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('copyMaterialBtn').addEventListener('click', function() {
            if (currentMaterial) {
                let textToCopy = currentMaterial.mat_data_raw || '';
                if (currentMaterial.eos_data_raw) {
                    textToCopy += '\n\n' + currentMaterial.eos_data_raw;
                }

                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('‚úÖ LS-DYNA –¥–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                }).catch(err => {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message);
                });
            }
        });

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function displayError(message) {
            document.getElementById('results').innerHTML = `<div class="error">${message}</div>`;
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMaterials();
            }
        });
    </script>
</body>
</html>