<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnson-Cook Model Calculator</title>
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="src/css/components/units.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="nav-menu">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">Material MAP</a>
            <button class="nav-toggle" aria-label="Toggle navigation">‚ò∞</button>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="swift_law_calculator.html">Swift's Law Calculator</a></li>
                <li><a href="mooney_rivlin_calculator.html">Mooney-Rivlin Calculator</a></li>
                <li><a href="johnson_cook_calculator.html">Johnson-Cook Calculator</a></li>
                <li><a href="gibson_ashby_calculator.html">Gibson-Ashby Calculator</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <h1>Johnson-Cook Model Simplified Parameters Calculator</h1>
        
        <!-- Disclaimer -->
        <div style="margin-bottom: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; border: 1px solid #ffeaa7;">
            <h3 style="margin: 0 0 10px 0; color: #856404; font-size: 18px;">‚ö†Ô∏è Important Disclaimer</h3>
            <p style="margin: 0 0 10px 0; color: #856404; line-height: 1.6; font-size: 14px;">
                This is a simplified implementation of the Johnson-Cook model using basic stress-strain data. The Johnson-Cook model applies only to plastic deformation behavior above the yield point. For accurate material modeling in high strain rate applications, experimental characterization at various strain rates and temperatures is essential.
            </p>
            <p style="margin: 0 0 10px 0; color: #856404; line-height: 1.6; font-size: 14px;">
                <strong>Methodology based on:</strong> Vasu Kumar Reddy Sirigiri, Vinith Yadav Gudiga, Uday Shankar Gattu, G. Suneesh, Krishna Mohan Buddaraju, "A review on Johnson Cook material model", Materials Today: Proceedings, Volume 62, Part 6, 2022, Pages 3450-3456, ISSN 2214-7853, <a href="https://doi.org/10.1016/j.matpr.2022.04.279" target="_blank" style="color: #856404; text-decoration: underline;">https://doi.org/10.1016/j.matpr.2022.04.279</a>
            </p>
            <p style="margin: 0; color: #856404; line-height: 1.6; font-size: 14px; font-weight: 600;">
                <strong>Note:</strong> The calculated parameters provide an initial approximation and should be validated against experimental data.
            </p>
        </div>
        
        <!-- Formula Information -->
        <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
            <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Johnson-Cook Constitutive Model</h2>
            <div style="font-size: 18px; font-weight: bold; margin: 15px 0; color: #2c3e50; font-family: 'Times New Roman', serif;">
                œÉy = (A + BŒµ·µñ‚Åø)(1 + C ln ŒµÃá*)(1 - T*·µê)
            </div>
            <div style="font-size: 14px; color: #7f8c8d; line-height: 1.5;">
                <strong>where:</strong> A - yield strength, B - hardening modulus, n - hardening exponent, C - strain rate coefficient, ŒµÃá* - dimensionless strain rate, T* - dimensionless temperature, m - temperature exponent, Œµ·µñ - plastic strain
            </div>
        </div>

        <!-- Units Panel -->
        <div class="units-panel">
            <h3>
                <span>üîß Units Settings</span>
                <button class="units-toggle" onclick="toggleUnitsPanel()">Show/Hide</button>
            </h3>
            <div id="unitsSettings" class="units-grid" style="display: none;">
                <div class="unit-group">
                    <label>Pressure/Stress Units:</label>
                    <select id="pressureUnit" onchange="updateUnits()">
                        <option value="MPa" selected>Megapascal (MPa)</option>
                        <option value="Pa">Pascal (Pa)</option>
                        <option value="kPa">Kilopascal (kPa)</option>
                        <option value="GPa">Gigapascal (GPa)</option>
                        <option value="psi">Pounds per square inch (psi)</option>
                    </select>
                </div>
                <div class="unit-group">
                    <label>Strain Units:</label>
                    <select id="strainUnit" onchange="updateUnits()">
                        <option value="" selected>Dimensionless (-)</option>
                        <option value="%">Percent (%)</option>
                    </select>
                </div>
                <div class="unit-group">
                    <label>Strain Rate Units:</label>
                    <select id="strainRateUnit" onchange="updateUnits()">
                        <option value="1/s" selected>Per second (s‚Åª¬π)</option>
                        <option value="1/min">Per minute (min‚Åª¬π)</option>
                    </select>
                </div>
                <div class="unit-group">
                    <label>Debug Mode:</label>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="debugMode" onchange="toggleDebugMode(this.checked)">
                        <label for="debugMode" style="margin-left: 5px;">Enable Debug Logging</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <div class="input-item with-units">
                <label for="yieldStrength">Yield Strength, œÉ<sub>y</sub>:</label>
                <div class="input-with-units">
                    <input type="number" id="yieldStrength" step="any" value="350" oninput="scheduleCalculation()">
                    <span class="unit-display" id="yieldStrengthUnit">MPa</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="ultimateStrength">Ultimate Strength, œÉ<sub>u</sub>:</label>
                <div class="input-with-units">
                    <input type="number" id="ultimateStrength" step="any" value="580" oninput="scheduleCalculation()">
                    <span class="unit-display" id="ultimateStrengthUnit">MPa</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="strainAtYield">Strain at Yield, Œµ<sub>y</sub>:</label>
                <div class="input-with-units">
                    <input type="number" id="strainAtYield" step="any" value="0.002" oninput="scheduleCalculation()">
                    <span class="unit-display" id="strainAtYieldUnit">-</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="strainAtUltimate">Strain at Ultimate, Œµ<sub>u</sub>:</label>
                <div class="input-with-units">
                    <input type="number" id="strainAtUltimate" step="any" value="0.20" oninput="scheduleCalculation()">
                    <span class="unit-display" id="strainAtUltimateUnit">-</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="youngModulus">Young's Modulus, E:</label>
                <div class="input-with-units">
                    <input type="number" id="youngModulus" step="any" value="200000" oninput="scheduleCalculation()">
                    <span class="unit-display" id="youngModulusUnit">MPa</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="strainRateCoeff">Strain Rate Coefficient, C:</label>
                <div class="input-with-units">
                    <input type="number" id="strainRateCoeff" step="any" value="0.014" oninput="scheduleCalculation()">
                    <span class="unit-display" id="strainRateCoeffUnit">-</span>
                </div>
            </div>
            <div class="input-item with-units">
                <label for="referenceStrainRate">Reference Strain Rate, ŒµÃá‚ÇÄ:</label>
                <div class="input-with-units">
                    <input type="number" id="referenceStrainRate" step="any" value="1.0" oninput="scheduleCalculation()">
                    <span class="unit-display" id="referenceStrainRateUnit">s‚Åª¬π</span>
                </div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <div class="result-item">
                <div class="result-name">Parameter A</div>
                <div class="result-value with-units">
                    <span id="parameterA">-</span>
                    <span class="result-unit" id="parameterAUnit">MPa</span>
                </div>
            </div>
            <div class="result-item">
                <div class="result-name">Parameter B</div>
                <div class="result-value with-units">
                    <span id="parameterB">-</span>
                    <span class="result-unit" id="parameterBUnit">MPa</span>
                </div>
            </div>
            <div class="result-item">
                <div class="result-name">Hardening Exponent, n</div>
                <div class="result-value with-units">
                    <span id="hardeningExponent">-</span>
                    <span class="result-unit">-</span>
                </div>
            </div>
            <div class="result-item">
                <div class="result-name">Strain Rate Coefficient, C</div>
                <div class="result-value with-units">
                    <span id="displayStrainRateCoeff">-</span>
                    <span class="result-unit">-</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="chartContainer" style="display: none;">
        <h2 class="collapsible-header collapsed" onclick="toggleCollapse(this)">Stress-Strain Curves for Different Strain Rates</h2>
        <div class="collapsible-content collapsed">
            <div class="chart-container">
                <div id="johnsonCookChart" style="width: 100%; height: 600px;">
                    <!-- Chart will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="tableContainer" style="display: none;">
        <h2 class="collapsible-header collapsed" onclick="toggleCollapse(this)">Data Table</h2>
        <div class="collapsible-content collapsed">
            <div class="table-header">
                <div></div>
                <button class="export-btn" onclick="exportToCSV()">üìä Export CSV</button>
            </div>
            <div class="table-container">
                <table id="parametersTable">
                    <thead>
                        <tr>
                            <th>Plastic Strain, Œµ·µñ [-]</th>
                            <th>Stress, œÉ (ŒµÃá = 0.001 s‚Åª¬π) [MPa]</th>
                            <th>Stress, œÉ (ŒµÃá = 1.0 s‚Åª¬π) [MPa]</th>
                            <th>Stress, œÉ (ŒµÃá = 1000 s‚Åª¬π) [MPa]</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <script src="navigation.js"></script>
    <script src="src/js/utils/UnitsHandler.js"></script>
    <script src="src/js/utils/PlotlyChartManager.js"></script>
    <script>
        let calculationTimeout;
        let currentData = {
            A: 0,
            B: 0,
            n: 0,
            C: 0
        };
        window.unitsHandler = new UnitsHandler();
        let chartManager = new PlotlyChartManager();
        let currentUnits = {
            pressure: 'MPa',
            strain: '',
            strainRate: '1/s'
        };

        // Initialize units handler when page loads
        window.addEventListener('load', async function() {
            const initialized = await unitsHandler.initialize();
            if (!initialized) {
                console.warn('Units handler initialization failed, using fallback');
            } else {
                console.log('Units handler initialized successfully');
                // Enable debug mode for troubleshooting
                unitsHandler.setDebugMode(true);
            }
            updateUnitDisplays();
        });

        function scheduleCalculation() {
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(calculate, 100);
        }

        function formatScientific(value, decimals = 3) {
            if (Math.abs(value) < 0.001 || Math.abs(value) >= 1000) {
                return value.toExponential(decimals);
            }
            return value.toFixed(decimals);
        }

        function toggleUnitsPanel() {
            const panel = document.getElementById('unitsSettings');
            panel.style.display = panel.style.display === 'none' ? 'grid' : 'none';
        }
        
        function toggleDebugMode(enabled) {
            if (unitsHandler && unitsHandler.initialized) {
                unitsHandler.setDebugMode(enabled);
                console.log(`Debug mode ${enabled ? 'enabled' : 'disabled'}`);
                if (enabled) {
                    console.log('Current units:', currentUnits);
                }
            }
        }

        function updateUnits() {
            console.log('updateUnits called');
            
            // Check if unitsHandler is available
            if (typeof unitsHandler === 'undefined') {
                console.error('UnitsHandler is not defined');
                return;
            }
            
            const oldUnits = { ...currentUnits };
            
            // Get new units
            currentUnits.pressure = document.getElementById('pressureUnit').value;
            currentUnits.strain = document.getElementById('strainUnit').value;
            currentUnits.strainRate = document.getElementById('strainRateUnit').value;
            
            console.log('Units changed from', oldUnits, 'to', currentUnits);
            
            // Convert pressure units for all input fields
            if (oldUnits.pressure !== currentUnits.pressure) {
                console.log(`Converting pressure from ${oldUnits.pressure} to ${currentUnits.pressure}`);
                
                // Convert yield strength
                const yieldStrength = parseFloat(document.getElementById('yieldStrength').value);
                if (!isNaN(yieldStrength)) {
                    const convertedValue = convertPressure(yieldStrength, oldUnits.pressure, currentUnits.pressure);
                    console.log(`Converting yieldStrength: ${yieldStrength} ${oldUnits.pressure} -> ${convertedValue.toFixed(3)} ${currentUnits.pressure}`);
                    document.getElementById('yieldStrength').value = formatValue(convertedValue);
                }
                
                // Convert ultimate strength
                const ultimateStrength = parseFloat(document.getElementById('ultimateStrength').value);
                if (!isNaN(ultimateStrength)) {
                    const convertedValue = convertPressure(ultimateStrength, oldUnits.pressure, currentUnits.pressure);
                    console.log(`Converting ultimateStrength: ${ultimateStrength} ${oldUnits.pressure} -> ${convertedValue.toFixed(3)} ${currentUnits.pressure}`);
                    document.getElementById('ultimateStrength').value = formatValue(convertedValue);
                }
                
                // Convert Young's modulus
                const youngModulus = parseFloat(document.getElementById('youngModulus').value);
                if (!isNaN(youngModulus)) {
                    const convertedValue = convertPressure(youngModulus, oldUnits.pressure, currentUnits.pressure);
                    console.log(`Converting youngModulus: ${youngModulus} ${oldUnits.pressure} -> ${convertedValue.toFixed(3)} ${currentUnits.pressure}`);
                    document.getElementById('youngModulus').value = formatValue(convertedValue);
                }
            }
            
            // Direct conversion for strain units (dimensionless to percent and vice versa)
            if (oldUnits.strain !== currentUnits.strain) {
                if ((oldUnits.strain === '' && currentUnits.strain === '%') || 
                    (oldUnits.strain === '%' && currentUnits.strain === '')) {
                    
                    const factor = oldUnits.strain === '' ? 100 : 0.01;
                    console.log(`Using direct strain conversion with factor ${factor}`);
                    
                    // Convert strain at yield
                    const strainAtYield = parseFloat(document.getElementById('strainAtYield').value);
                    if (!isNaN(strainAtYield)) {
                        const convertedValue = strainAtYield * factor;
                        console.log(`Converting strainAtYield: ${strainAtYield} ${oldUnits.strain || '-'} -> ${convertedValue} ${currentUnits.strain || '-'}`);
                        document.getElementById('strainAtYield').value = formatValue(convertedValue);
                    }
                    
                    // Convert strain at ultimate
                    const strainAtUltimate = parseFloat(document.getElementById('strainAtUltimate').value);
                    if (!isNaN(strainAtUltimate)) {
                        const convertedValue = strainAtUltimate * factor;
                        console.log(`Converting strainAtUltimate: ${strainAtUltimate} ${oldUnits.strain || '-'} -> ${convertedValue} ${currentUnits.strain || '-'}`);
                        document.getElementById('strainAtUltimate').value = formatValue(convertedValue);
                    }
                } else {
                    // For other conversions, try using the unitsHandler
                    convertInputValues(oldUnits, currentUnits);
                }
            }
            
            // Direct conversion for strain rate units (1/s to 1/min and vice versa)
            if (oldUnits.strainRate !== currentUnits.strainRate) {
                if ((oldUnits.strainRate === '1/s' && currentUnits.strainRate === '1/min') || 
                    (oldUnits.strainRate === '1/min' && currentUnits.strainRate === '1/s')) {
                    
                    const factor = oldUnits.strainRate === '1/s' ? 60 : 1/60;
                    console.log(`Using direct strain rate conversion with factor ${factor}`);
                    
                    // Convert reference strain rate
                    const referenceStrainRate = parseFloat(document.getElementById('referenceStrainRate').value);
                    if (!isNaN(referenceStrainRate)) {
                        const convertedValue = referenceStrainRate * factor;
                        console.log(`Converting referenceStrainRate: ${referenceStrainRate} ${oldUnits.strainRate} -> ${convertedValue} ${currentUnits.strainRate}`);
                        document.getElementById('referenceStrainRate').value = formatValue(convertedValue);
                    }
                } else {
                    // For other conversions, try using the unitsHandler
                    convertInputValues(oldUnits, currentUnits);
                }
            }
            
            // Update unit displays
            updateUnitDisplays();
            
            // Recalculate with new units
            scheduleCalculation();
        }
        
        function formatValue(value) {
            // Format the value appropriately
            if (Math.abs(value) < 0.001 || Math.abs(value) >= 10000) {
                return value.toExponential(4);
            } else {
                // Determine appropriate precision based on magnitude
                const precision = Math.abs(value) < 0.1 ? 5 : 
                                 Math.abs(value) < 1 ? 4 : 
                                 Math.abs(value) < 10 ? 3 : 
                                 Math.abs(value) < 100 ? 2 : 1;
                return value.toFixed(precision);
            }
        }
        
        function convertInputValues(oldUnits, newUnits) {
          console.log(`Converting values from ${JSON.stringify(oldUnits)} to ${JSON.stringify(newUnits)}`);
            
            if (!unitsHandler.initialized) {
                console.error('UnitsHandler not initialized');
                return;
            }
            
            // Convert pressure values
            if (oldUnits.pressure !== newUnits.pressure) {
                console.log(`Converting pressure values from ${oldUnits.pressure} to ${newUnits.pressure}`);
                
                // Direct conversion for MPa to GPa and vice versa
                if ((oldUnits.pressure === 'MPa' && newUnits.pressure === 'GPa') || 
                    (oldUnits.pressure === 'GPa' && newUnits.pressure === 'MPa')) {
                    
                    const factor = oldUnits.pressure === 'MPa' ? 0.001 : 1000;
                    
                    // Convert yield strength
                    const yieldStrength = parseFloat(document.getElementById('yieldStrength').value);
                    if (!isNaN(yieldStrength)) {
                        const convertedValue = yieldStrength * factor;
                        console.log(`Converting yieldStrength: ${yieldStrength} ${oldUnits.pressure} -> ${convertedValue} ${newUnits.pressure}`);
                        updateInputValue(document.getElementById('yieldStrength'), convertedValue);
                    }
                    
                    // Convert ultimate strength
                    const ultimateStrength = parseFloat(document.getElementById('ultimateStrength').value);
                    if (!isNaN(ultimateStrength)) {
                        const convertedValue = ultimateStrength * factor;
                        console.log(`Converting ultimateStrength: ${ultimateStrength} ${oldUnits.pressure} -> ${convertedValue} ${newUnits.pressure}`);
                        updateInputValue(document.getElementById('ultimateStrength'), convertedValue);
                    }
                    
                    // Convert Young's modulus
                    const youngModulus = parseFloat(document.getElementById('youngModulus').value);
                    if (!isNaN(youngModulus)) {
                        const convertedValue = youngModulus * factor;
                        console.log(`Converting youngModulus: ${youngModulus} ${oldUnits.pressure} -> ${convertedValue} ${newUnits.pressure}`);
                        updateInputValue(document.getElementById('youngModulus'), convertedValue);
                    }
                } else {
                    // Use UnitsHandler for other conversions
                      convertInputField('yieldStrength', oldUnits.pressure, newUnits.pressure);
                    convertInputField('ultimateStrength', oldUnits.pressure, newUnits.pressure);
                    convertInputField('youngModulus', oldUnits.pressure, newUnits.pressure);
                }
            }
            
            // Convert strain values
            if (oldUnits.strain !== newUnits.strain) {
                console.log(`Converting strain values from ${oldUnits.strain} to ${newUnits.strain}`);
                
                // Direct conversion for dimensionless to percent and vice versa
                if ((oldUnits.strain === '' && newUnits.strain === '%') || 
                    (oldUnits.strain === '%' && newUnits.strain === '')) {
                    
                    const factor = oldUnits.strain === '' ? 100 : 0.01;
                    
                    // Convert strain at yield
                    const strainAtYield = parseFloat(document.getElementById('strainAtYield').value);
                    if (!isNaN(strainAtYield)) {
                        const convertedValue = strainAtYield * factor;
                        console.log(`Converting strainAtYield: ${strainAtYield} ${oldUnits.strain || '-'} -> ${convertedValue} ${newUnits.strain || '-'}`);
                        updateInputValue(document.getElementById('strainAtYield'), convertedValue);
                    }
                    
                    // Convert strain at ultimate
                    const strainAtUltimate = parseFloat(document.getElementById('strainAtUltimate').value);
                    if (!isNaN(strainAtUltimate)) {
                        const convertedValue = strainAtUltimate * factor;
                        console.log(`Converting strainAtUltimate: ${strainAtUltimate} ${oldUnits.strain || '-'} -> ${convertedValue} ${newUnits.strain || '-'}`);
                        updateInputValue(document.getElementById('strainAtUltimate'), convertedValue);
                    }
                } else {
                    // Use UnitsHandler for other conversions
                    convertInputField('strainAtYield', oldUnits.strain || '', newUnits.strain || '');
                    convertInputField('strainAtUltimate', oldUnits.strain || '', newUnits.strain || '');
                }
            }
            
            // Convert strain rate values
            if (oldUnits.strainRate !== newUnits.strainRate) {
                console.log(`Converting strain rate values from ${oldUnits.strainRate} to ${newUnits.strainRate}`);
                
                // Direct conversion for 1/s to 1/min and vice versa
                if ((oldUnits.strainRate === '1/s' && newUnits.strainRate === '1/min') || 
                    (oldUnits.strainRate === '1/min' && newUnits.strainRate === '1/s')) {
                    
                    const factor = oldUnits.strainRate === '1/s' ? 60 : 1/60;
                    
                    // Convert reference strain rate
                    const referenceStrainRate = parseFloat(document.getElementById('referenceStrainRate').value);
                    if (!isNaN(referenceStrainRate)) {
                        const convertedValue = referenceStrainRate * factor;
                        console.log(`Converting referenceStrainRate: ${referenceStrainRate} ${oldUnits.strainRate} -> ${convertedValue} ${newUnits.strainRate}`);
                        updateInputValue(document.getElementById('referenceStrainRate'), convertedValue);
                    }
                } else {
                    // Use UnitsHandler for other conversions
                    convertInputField('referenceStrainRate', oldUnits.strainRate, newUnits.strainRate);
                }
            }
        }
        
        function updateInputValue(input, value) {
            // Format the value appropriately
            if (Math.abs(value) < 0.001 || Math.abs(value) >= 10000) {
                input.value = value.toExponential(4);
            } else {
                // Determine appropriate precision based on magnitude
                const precision = Math.abs(value) < 0.1 ? 5 : 
                                 Math.abs(value) < 1 ? 4 : 
                                 Math.abs(value) < 10 ? 3 : 
                                 Math.abs(value) < 100 ? 2 : 1;
                input.value = value.toFixed(precision);
            }
        }
        
        function convertInputField(elementId, fromUnit, toUnit) {
            console.log(`Converting ${elementId} from ${fromUnit} to ${toUnit}`);
            
            const input = document.getElementById(elementId);
            if (!input) {
                console.error(`Element with ID ${elementId} not found`);
                return;
            }
            
            const value = parseFloat(input.value);
            if (isNaN(value)) {
                console.warn(`Value in ${elementId} is not a number: ${input.value}`);
                return;
            }
            
            // Skip conversion if units are the same
            if (fromUnit === toUnit) {
                console.log(`Units are the same (${fromUnit}), skipping conversion`);
                return;
            }
            
            console.log(`Converting value ${value} ${fromUnit} to ${toUnit}`);
            
            // Handle direct conversion for strain (dimensionless to percent and vice versa)
            if ((fromUnit === '' && toUnit === '%') || (fromUnit === '%' && toUnit === '')) {
                const convertedValue = fromUnit === '%' ? value / 100 : value * 100;
                console.log(`Direct strain conversion: ${value} ${fromUnit} -> ${convertedValue} ${toUnit}`);
                updateInputValue(input, convertedValue);
                return;
            }
            
            // Use UnitsHandler for other conversions
            const quantity = unitsHandler.createQuantity(value, fromUnit);
            if (!quantity) {
                console.error(`Failed to create quantity for ${value} ${fromUnit}`);
                return;
            }
            
            const converted = unitsHandler.convert(quantity, toUnit);
            if (!converted) {
                console.error(`Failed to convert ${value} ${fromUnit} to ${toUnit}`);
                return;
            }
            
            const convertedValue = unitsHandler.getValue(converted);
            console.log(`Converted value: ${value} ${fromUnit} -> ${convertedValue} ${toUnit}`);
            
            updateInputValue(input, convertedValue);
        }
        
        function updateInputValue(input, value) {
            // Format the value appropriately
            if (Math.abs(value) < 0.001 || Math.abs(value) >= 10000) {
                input.value = value.toExponential(4);
            } else {
                // Determine appropriate precision based on magnitude
                const precision = Math.abs(value) < 0.1 ? 5 : 
                                 Math.abs(value) < 1 ? 4 : 
                                 Math.abs(value) < 10 ? 3 : 
                                 Math.abs(value) < 100 ? 2 : 1;
                input.value = value.toFixed(precision);
            }
        }

        function updateUnitDisplays() {
            // Update input unit displays
            document.getElementById('yieldStrengthUnit').textContent = currentUnits.pressure;
            document.getElementById('ultimateStrengthUnit').textContent = currentUnits.pressure;
            document.getElementById('youngModulusUnit').textContent = currentUnits.pressure;
            document.getElementById('strainAtYieldUnit').textContent = currentUnits.strain || '-';
            document.getElementById('strainAtUltimateUnit').textContent = currentUnits.strain || '-';
            document.getElementById('strainRateCoeffUnit').textContent = '-';
            document.getElementById('referenceStrainRateUnit').textContent = 
                currentUnits.strainRate === '1/s' ? 's‚Åª¬π' : 'min‚Åª¬π';

            // Update result unit displays
            document.getElementById('parameterAUnit').textContent = currentUnits.pressure;
            document.getElementById('parameterBUnit').textContent = currentUnits.pressure;
        }

        // Helper function to convert pressure units
        function convertPressure(value, fromUnit, toUnit) {
            if (fromUnit === toUnit) return value;
            
            // Try using UnitsHandler first if available
            if (unitsHandler && unitsHandler.initialized) {
                try {
                    const quantity = unitsHandler.createQuantity(value, fromUnit);
                    if (quantity) {
                        const converted = unitsHandler.convert(quantity, toUnit);
                        if (converted) {
                            return unitsHandler.getValue(converted);
                        }
                    }
                } catch (error) {
                    console.warn('UnitsHandler conversion failed, using fallback:', error);
                }
            }
            
            // Fallback to simple conversion
            // Convert to Pa first (base unit)
            let valueInPa = value;
            switch(fromUnit) {
                case 'Pa': valueInPa = value; break;
                case 'kPa': valueInPa = value * 1000; break;
                case 'MPa': valueInPa = value * 1000000; break;
                case 'GPa': valueInPa = value * 1000000000; break;
                case 'psi': valueInPa = value * 6894.76; break;
            }
            
            // Convert from Pa to target unit
            switch(toUnit) {
                case 'Pa': return valueInPa;
                case 'kPa': return valueInPa / 1000;
                case 'MPa': return valueInPa / 1000000;
                case 'GPa': return valueInPa / 1000000000;
                case 'psi': return valueInPa / 6894.76;
                default: return valueInPa / 1000000; // Default to MPa
            }
        }

        function getValueInBaseUnits(elementId, quantityType) {
            const value = parseFloat(document.getElementById(elementId).value);
            const unit = currentUnits[quantityType];
            
            if (!unitsHandler.initialized) {
                return value; // Fallback to raw value
            }

            const quantity = unitsHandler.createQuantity(value, unit);
            if (!quantity) return value;

            const baseUnit = unitsHandler.getPrimaryUnit(quantityType);
            const converted = unitsHandler.convert(quantity, baseUnit);
            return converted ? unitsHandler.getValue(converted) : value;
        }

        function convertToDisplayUnits(value, quantityType) {
            if (!unitsHandler.initialized) {
                return value; // Fallback to raw value
            }

            const baseUnit = unitsHandler.getPrimaryUnit(quantityType);
            const displayUnit = currentUnits[quantityType];
            
            const quantity = unitsHandler.createQuantity(value, baseUnit);
            if (!quantity) return value;

            const converted = unitsHandler.convert(quantity, displayUnit);
            return converted ? unitsHandler.getValue(converted) : value;
        }

        function calculate() {
            // Get values in base units (MPa for pressure, dimensionless for strain)
            const sigmaY = getValueInBaseUnits('yieldStrength', 'pressure');
            const sigmaU = getValueInBaseUnits('ultimateStrength', 'pressure');
            const epsilonY = getValueInBaseUnits('strainAtYield', 'strain');
            const epsilonU = getValueInBaseUnits('strainAtUltimate', 'strain');
            const C = parseFloat(document.getElementById('strainRateCoeff').value);

            // Validate inputs
            if (isNaN(sigmaY) || isNaN(sigmaU) || isNaN(epsilonY) || isNaN(epsilonU) || isNaN(C)) {
                return;
            }

            // Calculate Johnson-Cook parameters (in base units)
            const A = sigmaY; // Parameter A = yield strength
            const n = Math.log(sigmaU / sigmaY) / Math.log(epsilonU / epsilonY); // Hardening exponent
            const B = (sigmaU - sigmaY) / Math.pow(0.2, n); // Hardening modulus

            // Store current data in base units
            currentData = { A, B, n, C };

            // Convert results to display units and show
            const displayA = convertToDisplayUnits(A, 'pressure');
            const displayB = convertToDisplayUnits(B, 'pressure');

            document.getElementById('parameterA').textContent = formatScientific(displayA);
            document.getElementById('parameterB').textContent = formatScientific(displayB);
            document.getElementById('hardeningExponent').textContent = formatScientific(n, 4);
            document.getElementById('displayStrainRateCoeff').textContent = formatScientific(C, 4);

            // Show results
            document.getElementById('results').style.display = 'grid';
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'block';

            // Update chart and table
            updateChart();
            updateTable();
        }

        function johnsonCookStress(totalStrain, strainRate, referenceRate = 1.0) {
            const { A, B, n, C } = currentData;
            // Get values in base units
            const epsilonY = getValueInBaseUnits('strainAtYield', 'strain');
            const E = getValueInBaseUnits('youngModulus', 'pressure');
            
            // If strain is less than yield strain, use elastic behavior (Hooke's law)
            if (totalStrain <= epsilonY) {
                return E * totalStrain;
            }
            
            // Calculate plastic strain (only after yielding)
            const plasticStrain = totalStrain - epsilonY;
            
            // Strain rate factor (ensure it doesn't go below reasonable minimum)
            let strainRateFactor = 1 + C * Math.log(strainRate / referenceRate);
            strainRateFactor = Math.max(strainRateFactor, 0.1); // Prevent negative or very low values
            
            // Johnson-Cook model applies only to plastic deformation
            // Total stress = yield stress + plastic hardening
            const plasticStressIncrement = B * Math.pow(plasticStrain, n) * strainRateFactor;
            return A + plasticStressIncrement;
        }

        function updateChart() {
           if (!chartManager.isPlotlyLoaded()) {
                console.warn('Plotly.js not loaded, skipping chart update');
                return;
            }

            const strainRates = [0.001, 1.0, 1000];
            const epsilonY = parseFloat(document.getElementById('strainAtYield').value);
            const referenceStrainRate = parseFloat(document.getElementById('referenceStrainRate').value);

            const options = {
                maxPlasticStrain: 0.25,
                yieldStrain: epsilonY,
                referenceStrainRate: referenceStrainRate,
                stressUnit: currentUnits.pressure
            };

            chartManager.createJohnsonCookChart('johnsonCookChart', currentData, strainRates, options)
                .catch(error => {
                    console.error('Error creating Johnson-Cook chart:', error);
                 });
        }

        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const referenceRate = parseFloat(document.getElementById('referenceStrainRate').value);
            const strainRates = [0.001, 1.0, 1000];
            const epsilonY = parseFloat(document.getElementById('strainAtYield').value);

            // Show only plastic strain values (starting from 0)
            for (let plasticStrain = 0; plasticStrain <= 0.25; plasticStrain += 0.02) {
                const row = document.createElement('tr');
                
                // Plastic strain
                const strainCell = document.createElement('td');
                strainCell.textContent = plasticStrain.toFixed(3);
                row.appendChild(strainCell);

                // Stress values for different strain rates
                const totalStrain = epsilonY + plasticStrain;
                strainRates.forEach(rate => {
                    const stressCell = document.createElement('td');
                    const stress = johnsonCookStress(totalStrain, rate, referenceRate);
                    stressCell.textContent = formatScientific(stress);
                    row.appendChild(stressCell);
                });

                tableBody.appendChild(row);
            }
        }

        function exportToCSV() {
            const referenceRate = parseFloat(document.getElementById('referenceStrainRate').value);
            const strainRates = [0.001, 1.0, 1000];
            const epsilonY = parseFloat(document.getElementById('strainAtYield').value);
            
            let csv = 'Plastic Strain Œµ·µñ [-],Stress œÉ (ŒµÃá = 0.001 s‚Åª¬π) [MPa],Stress œÉ (ŒµÃá = 1.0 s‚Åª¬π) [MPa],Stress œÉ (ŒµÃá = 1000 s‚Åª¬π) [MPa]\n';
            
            for (let plasticStrain = 0; plasticStrain <= 0.25; plasticStrain += 0.02) {
                let row = plasticStrain.toFixed(3);
                const totalStrain = epsilonY + plasticStrain;
                strainRates.forEach(rate => {
                    const stress = johnsonCookStress(totalStrain, rate, referenceRate);
                    row += ',' + formatScientific(stress);
                });
                csv += row + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'johnson_cook_data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleCollapse(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Initialize calculation on page load
        window.addEventListener('load', () => {
            calculate();
        });
    </script>
</body>
</html>
