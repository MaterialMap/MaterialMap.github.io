name: Generate TOML File List

on:
  push:
    branches:
      - main
    paths:
      - 'data/*.toml'  # Запускается только при изменении TOML файлов
  workflow_dispatch: # Возможность ручного запуска

# Allow only one concurrent file list generation, cancel in-progress runs
concurrency:
  group: "file-list-generation"
  cancel-in-progress: true

jobs:
  generate-file-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Получаем полную историю для git log

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate TOML files before processing
      run: |
        echo "🔍 Validating TOML files before generating file list..."
        if ! npm run validate-data; then
          echo "❌ TOML validation failed! File list will not be updated."
          echo "Please fix TOML errors and try again."
          exit 1
        fi
        echo "✅ All TOML files are valid, proceeding with file list generation..."

    - name: Generate TOML file list with modification dates
      run: |
        mkdir -p dist
        node -e "
        const fs = require('fs');
        const path = require('path');
        const { execSync } = require('child_process');
        const dataDir = path.join(__dirname, 'data');
        const files = fs.readdirSync(dataDir).filter(file => file.endsWith('.toml'));
        
        const fileData = files.map(file => {
          const filePath = path.join(dataDir, file);
          let lastModified;
          
          try {
            // Extract the base name without extension for searching in commit messages
            const baseName = path.basename(file, '.toml');
            
            // Try to find a commit that specifically mentions this file or material
            let gitDate = null;
            
            try {
              // First, try to find commits that mention the file name in the message
              const commitSearch = execSync(\`git log --all --grep=\"\${baseName}\" --format=%cI | head -1\`, { encoding: 'utf8' }).trim();
              if (commitSearch) {
                gitDate = commitSearch;
              }
            } catch (e) {
              // Ignore grep errors
            }
            
            // If no specific commit found, try to get the first commit that added this file
            if (!gitDate) {
              try {
                const firstCommit = execSync(\`git log --reverse --format=%cI -- \"\${filePath}\" | head -1\`, { encoding: 'utf8' }).trim();
                if (firstCommit) {
                  gitDate = firstCommit;
                }
              } catch (e) {
                // Ignore errors
              }
            }
            
            // Convert to date-only format (YYYY-MM-DD)
            const dateOnly = gitDate ? new Date(gitDate).toISOString().split('T')[0] : new Date(fs.statSync(filePath).mtime).toISOString().split('T')[0];
            lastModified = dateOnly;
            
          } catch (error) {
            // Fallback to file system modification time (date only)
            lastModified = new Date(fs.statSync(filePath).mtime).toISOString().split('T')[0];
          }
          
          return {
            filename: file,
            lastModified: lastModified
          };
        });
        
        fs.writeFileSync('dist/file-list.json', JSON.stringify(fileData, null, 2));
        console.log('Generated file-list.json with modification dates:', fileData);
        "
        
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet dist/file-list.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push file list
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        git add dist/file-list.json
        git commit -m "Update file list [skip ci]"
        git push origin main