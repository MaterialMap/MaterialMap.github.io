name: Generate TOML File List

on:
  push:
    branches:
      - main # Запускается при пуше в ветку main
  workflow_dispatch: # Возможность ручного запуска

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Или другая версия Node.js

    - name: Generate TOML file list with modification dates
      run: |
        mkdir -p dist # Создаем директорию для вывода
        node -e "
        const fs = require('fs');
        const path = require('path');
        const { execSync } = require('child_process');
        const dataDir = path.join(__dirname, 'data');
        const files = fs.readdirSync(dataDir).filter(file => file.endsWith('.toml'));
        
        const fileData = files.map(file => {
          const filePath = path.join(dataDir, file);
          let lastModified;
          
          try {
            // Try to get last commit date for the file
            const gitDate = execSync(\`git log -1 --format=%cI -- \"\${filePath}\"\`, { encoding: 'utf8' }).trim();
            lastModified = gitDate || new Date(fs.statSync(filePath).mtime).toISOString();
          } catch (error) {
            // Fallback to file system modification time
            lastModified = new Date(fs.statSync(filePath).mtime).toISOString();
          }
          
          return {
            filename: file,
            lastModified: lastModified
          };
        });
        
        fs.writeFileSync('dist/file-list.json', JSON.stringify(fileData, null, 2));
        console.log('Generated file-list.json with modification dates:', fileData);
        "
    - name: Commit and push file list
      run: |
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        git add dist/file-list.json
        git commit -m "Update file list [skip ci]" || echo "No changes to commit"
        git push origin main
    
    - name: Upload file list artifact # Добавляем шаг для загрузки артефакта
      uses: actions/upload-artifact@v4
      with:
        name: file-list-json # Имя артефакта
        path: dist/file-list.json # Путь к файлу